<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>×”×¡× ×™×£ ×”×“×™×’×™×˜×œ×™</title>
<style>
/* â€¦ ×›×œ ×”Ö¾CSS ×©×œ×š ×‘×“×™×•×§ ×›×ž×• ×©×”×™×” â€¦ */
</style>
</head>
<body>
  <!-- â€¦ ×›×œ ×”Ö¾HTML ×©×œ×š ×‘×“×™×•×§ ×›×ž×• ×©×”×™×” â€¦ -->

<script>
  /* ===== × ×ª×•× ×™× ×‘×¡×™×¡×™×™× ===== */
  const PHONES = {
    "×ž××•×¨":"972546819166",
    "×¢×™×“×•":"972559877777"
  }; // ×™×¢×“×™ ×•×•××˜×¡××¤

  const STARTER_FOR_EVEN_DAY = "×ž××•×¨";
  const STARTER_FOR_ODD_DAY  = "×¢×™×“×•";
  const ENFORCE_WITHDRAW_RULES = false;

  /* ===== ×¨×¤×¨× ×¡×™× ===== */
  const amountModal = document.getElementById('amountModal');
  const amountInput = document.getElementById('amountInput');
  const nicknameInput = document.getElementById('nicknameInput');
  let pendingPhone = null;

  const withdrawLink = document.getElementById('withdrawGroupLink');
  const withdrawBlockedModal = document.getElementById('withdrawBlockedModal');
  const withdrawFormModal = document.getElementById('withdrawFormModal');
  const nextDateSpan = document.getElementById('nextWithdrawDate');

  const wdAmount = document.getElementById('wdAmount');
  const wdKeep   = document.getElementById('wdKeep');
  const wdNick   = document.getElementById('wdNick');
  const wdMethod = document.getElementById('wdMethod');

  const WITHDRAW_GROUP_URL = "https://chat.whatsapp.com/GDw1GilqCab6Un2TspiWBP?mode=wwc";

  /* ===== ×–×ž×Ÿ ×ž×§×•×ž×™ ===== */
  function nowIL(){
    const d=new Date();
    const parts=new Intl.DateTimeFormat("he-IL",{timeZone:"Asia/Jerusalem",hour12:false,hour:"2-digit",minute:"2-digit",weekday:"short"}).formatToParts(d);
    const get=t=>parts.find(x=>x.type===t)?.value;
    const h=+get("hour"), m=+get("minute"), wd=get("weekday");
    const map={"×™×•× ××³":0,"×™×•× ×‘×³":1,"×™×•× ×’×³":2,"×™×•× ×“×³":3,"×™×•× ×”×³":4,"×™×•× ×•×³":5,"×™×•× ×©×³":6,"×™×•× ×©×‘×ª":6};
    return { day: map[wd] ?? d.getDay(), minutes: h*60 + m };
  }

  /* ×ž×™ ×‘×ž×©×ž×¨×ª ×¢×›×©×™×•? */
  function currentShiftOwner(){
    const n = nowIL();
    const shiftIndex = Math.floor(n.minutes / 180);
    const dayStarter = (n.day % 2 === 0) ? STARTER_FOR_EVEN_DAY : STARTER_FOR_ODD_DAY;
    const other      = (dayStarter === "×ž××•×¨") ? "×¢×™×“×•" : "×ž××•×¨";
    return (shiftIndex % 2 === 0) ? dayStarter : other;
  }

  function isWithdrawWindowOpen(){
    if (!ENFORCE_WITHDRAW_RULES) return true;
    const n = nowIL();
    return n.day===2 && n.minutes>=18*60 && n.minutes<24*60;
  }

  function nextWithdrawDateString(){
    const n=nowIL(); const now=new Date();
    const TUE=2, start=18*60; let addDays;
    if(n.day===TUE && n.minutes<start) addDays=0;
    else { addDays=(TUE-n.day+7)%7; if(addDays===0) addDays=7; }
    const target=new Date(now.getFullYear(), now.getMonth(), now.getDate()+addDays);
    return new Intl.DateTimeFormat('he-IL',{timeZone:'Asia/Jerusalem',day:'2-digit',month:'2-digit',year:'numeric'}).format(target);
  }

  function setBusy(el){ if(!el) return; el.classList.add('busy'); setTimeout(()=> el.classList.remove('busy'), 900); }

  document.querySelectorAll('.pay-btn[data-type="paybox"]').forEach(a=>{
    a.addEventListener('click', function(){ setBusy(this); });
  });

  /* ===== ×˜×¢×™× ×•×ª (bit) ===== */
  function startWhatsappFlow(btn){
    setBusy(btn?.closest('.pay-btn') || btn);
    const owner = currentShiftOwner();
    pendingPhone = PHONES[owner] || PHONES["×ž××•×¨"];
    amountModal.classList.add('show');
    setTimeout(()=> (amountInput.value ? nicknameInput : amountInput).focus(), 80);
  }

  function closeAmountModal(){ amountModal.classList.remove('show'); }

  function confirmAmount(){
    const rawAmount=(amountInput.value||'').trim();
    const nick=(nicknameInput.value||'').trim();
    const amount=Math.floor(Number(rawAmount));
    if(!rawAmount||!Number.isFinite(amount)||amount<=0){ amountInput.focus(); amountInput.select?.(); return; }
    if(nick.length<2){ nicknameInput.focus(); return; }

    const msg = `×”×˜×¢× ×ª×™ ×œ×š ×‘-BIT ×¡×›×•× ×©×œ ${amount} ×©"×—.\n×”×›×™× ×•×™ ×©×œ×™ ×”×•×: ${nick}\n×ª×˜×¢×™×Ÿ ×œ×™ ×¦'×™×¤×™× ×‘×‘×§×©×” (:`;    
    window.open(`https://api.whatsapp.com/send?phone=${pendingPhone}&text=${encodeURIComponent(msg)}`,"_blank");
    amountInput.value=""; nicknameInput.value=""; closeAmountModal();
  }

  /* ===== ×ž×©×™×›×•×ª ===== */
  withdrawLink.addEventListener('click', (e)=>{
    if(!isWithdrawWindowOpen()){
      e.preventDefault();
      nextDateSpan.textContent = nextWithdrawDateString();
      withdrawBlockedModal.classList.add('show');
    } else {
      e.preventDefault();
      openWithdrawForm();
    }
  });

  function openWithdrawForm(){ withdrawFormModal.classList.add('show'); setTimeout(()=> wdAmount.focus(),80); }
  function closeWithdrawForm(){ withdrawFormModal.classList.remove('show'); }
  function closeWithdrawBlocked(){ withdrawBlockedModal.classList.remove('show'); }

  /* âœ… ×¤×•× ×§×¦×™×” ×ž×¢×•×“×›× ×ª */
  function confirmWithdraw(){
    const rawA=(wdAmount.value||'').trim();
    const rawK=(wdKeep.value||'').trim();
    const nick=(wdNick.value||'').trim();
    const method=wdMethod.value;

    const amount=Math.floor(Number(rawA));
    const keep=Math.floor(Number(rawK||"0"));

    if(!rawA||!Number.isFinite(amount)||amount<=0){ wdAmount.focus(); wdAmount.select?.(); return; }
    if(keep<0){ wdKeep.focus(); wdKeep.select?.(); return; }
    if(nick.length<2){ wdNick.focus(); return; }
    if(method!=='×‘×™×˜' && method!=='×¤×™×™×‘×•×§×¡'){ wdMethod.focus(); return; }

    const msg =
`×‘×§×©×ª ×ž×©×™×›×” ðŸ’¸

×›×™× ×•×™ ×‘××¤×œ×™×§×¦×™×”: ${nick} ðŸŽ¯
×¡×›×•× ×œ×ž×©×™×›×”: ${amount} â‚ª
×¡×›×•× ×œ×”×©××™×¨: ${keep} â‚ª
××•×¤×Ÿ ×ª×©×œ×•×: ${method} ðŸ’°

×ª×•×“×”! ðŸ™`;

    const url = `https://wa.me/?text=${encodeURIComponent(msg)}`;
    window.open(url, "_blank", "noopener");

    wdAmount.value=""; wdKeep.value=""; wdNick.value=""; wdMethod.value="";
    closeWithdrawForm();
  }

  function paintWithdrawButtonState(){
    const btn = document.getElementById('withdrawGroupLink');
    if(!btn) return;
    if (isWithdrawWindowOpen()) btn.classList.remove('disabled');
    else                        btn.classList.add('disabled');
  }
  paintWithdrawButtonState();
  setInterval(paintWithdrawButtonState, 60*1000);

  function copyText(t){ navigator.clipboard.writeText(t); alert("×”×•×¢×ª×§!"); }

  /* ===== ×ž×™ ×‘×ž×©×ž×¨×ª ===== */
  const shiftModal = document.getElementById('shiftModal');
  const shiftModalText = document.getElementById('shiftModalText');

  function openShiftModal() {
    const name = currentShiftOwner();
    shiftModalText.textContent = `×‘×ž×©×ž×¨×ª: ${name}`;
    shiftModal.classList.add('show');
  }
  function closeShiftModal() { shiftModal.classList.remove('show'); }
</script>
</body>
</html>
